name: Update Hugging Face Space (crawl + upload)

on:
  workflow_dispatch:
  schedule:
    # 每天跑一次（你可以改时间）
    - cron: "17 6 * * *"

concurrency:
  group: hf-space-update
  cancel-in-progress: true

jobs:
  crawl_and_upload:
    runs-on: ubuntu-22.04
    timeout-minutes: 70

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies (actions)
        run: |
          python -m pip install --upgrade pip
          pip install -r ./crawler/requirements.txt

      - name: Crawl Cheshire Academy site
        env:
          CA_BASE_URL: "https://www.cheshireacademy.org"
          CA_SOURCES_DIR: "sources"
          CA_MAX_PAGES: "4000"
          CA_MAX_DISCOVERED: "50000"
          CA_MAX_DEPTH: "6"
          CA_HTTP_TIMEOUT: "20"
          CA_CONNECT_TIMEOUT: "10"
          CA_SLEEP: "0.08"
          CA_RETRIES: "2"
          CA_BACKOFF: "0.8"
          # 如需额外域名（比如 athletics 子域），在这里加
          # CA_ALLOWED_DOMAINS: "cheshireacademy.org,www.cheshireacademy.org,athletics.cheshireacademy.org"
        run: |
          python ./crawler/crawl_site.py

      - name: Prepare hf_space folder
        run: |
          rm -rf hf_space/sources
          mkdir -p hf_space/sources
          cp -r sources/* hf_space/sources/

      - name: Upload to Hugging Face Space
        env:
          HF_SPACE_ID : ${{ secrets.HF_SPACE_ID  }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_REPO: "abyss20090/ca_widget"
          HF_SPACE_DIR: "hf_space"

          # 更稳的上传参数
          HF_UPLOAD_MODE: "large_then_batch"
          HF_MAX_RETRIES: "10"
          HF_HTTP_TIMEOUT: "1200"
          HF_COMMIT_BATCH: "25"

          # 让 hf_transfer 生效（你 requirements.txt 里已装 hf_transfer）
          HF_HUB_ENABLE_HF_TRANSFER: "1"
        run: |
          python ./crawler/upload_to_hf.py
